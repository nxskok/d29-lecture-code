---
title: "March 6"
output: html_notebook
---

## Repeated measures (review)

slide 307

Histamine in dogs:

```{r}
my_url="http://www.utsc.utoronto.ca/~butler/d29/dogs.txt"
dogs=read_table(my_url)
dogs
```

```{r}
response=with(dogs,cbind(lh0,lh1,lh3,lh5))
dogs.1=lm(response~drug,data=dogs)
```

We have some extra setup to express that these are the same thing measured at different times:

```{r}
response
times=colnames(response)
times.df=data.frame(times)
```

Then the analysis

```{r}
Manova(dogs.1, idata=times.df, idesign=~times)
```

The effect of drug is different at different times.

To investigate what, we can draw a graph. But for that, need *long* format:

```{r}
dogs %>% gather(timex,lh,lh0:lh5) %>% 
  mutate(time=parse_number(timex)) -> dogs.long
dogs.long
```

Make an interaction plot of log-histamine against time, labelled by drug:

```{r}
ggplot(dogs.long,aes(x=time, y=lh ,colour=drug, group=drug))+
  stat_summary(fun.y=mean,geom="point")+
  stat_summary(fun.y=mean,geom="line")
```

This shows that log-histamine levels are similar at time zero, but for all times after that, trimethaphan log-histamine levels are higher.

Spaghetti plot - join all the measurements for each individual (dog) with a line:

```{r}
ggplot(dogs.long,aes(x=time, y=lh, colour=drug, group=dog)) +
  geom_point()+geom_line()
```

Time zero really ought not to be included in the analysis, because there is no time for the drugs to have an effect. (There is usually a value noted at time zero so that we can confirm the drugs were not different then.) 

So let's go back to the original data frame and exclude time zero. This means redefining the response and following through:

```{r}
response=with(dogs,cbind(lh1, lh3, lh5)) # excluding time zero
dogs.2=lm(response~drug, data=dogs)
times=colnames(response)
times
times.df=data.frame(times)
times.df
Manova(dogs.2,idata=times.df, idesign=~times)
```

The interaction is no longer significant. Go back and look at interaction plot and spaghetti plot for why.

Cannot take it out (interaction of "within-subject" factor `times` and "between-subject" factor `drug`). So ignore it, because it is non-significant, and interpret the main effects: an effect of time, but an only marginally significant effect of drug. 


Mixed model approach, using `lme4`:

Make sure to use the *text* time instead of the numerical time, to get it treated as categorical (otherwise gets treated as regression, linear in time, which it is not).

```{r}
dogs.3=lmer(lh~timex*drug+(1|dog), data=dogs.long)
drop1(dogs.3, test="Chisq")
```

This time the interaction is strongly significant.

or omit time zero:

```{r}
dogs.long %>% filter(time>0) -> d
dogs.4=lmer(lh~timex*drug+(1|dog), data=d) 
drop1(dogs.4, test="Chisq")
```

this time the interaction is still significant. 

Another example: exercise, see slide 325.

```{r}
my_url="http://www.utsc.utoronto.ca/~butler/d29/exercise.txt"
exercise.long=read_tsv(my_url)
exercise.long
```

Diet and exercise type are between-subjects, but time is within-subjects. (Each subject does one diet and one type of exercise all the way through, but is measured at several different times.) 

Make *wide* for analysis:

```{r}
exercise.long %>% spread(time, pulse) -> exercise.wide
exercise.wide
```

Make response:

```{r}
response=with(exercise.wide, cbind(min01, min15, min30))
```

Predict from diet and exercise type:

```{r}
exercise.1=lm(response~diet*exertype, data=exercise.wide)
```

Manova:

```{r}
times=colnames(response)
times.df=data.frame(times)
Manova(exercise.1, idata=times.df, idesign=~times)
```

Now have significant *three*-way interaction: the effect of the combination of diet and exercise type is itself different at different times.

Spaghetti plot:

```{r}
ggplot(exercise.long, aes(x=time, y=pulse, group=id))+
  geom_point()+geom_line()
```

but normally we'd have a colour = something, and here we have two somethings: diet and exercise type. So instead have facets for these. With two things to facet by, use `facet_grid` to have one as rows and the other as columns:

```{r}
ggplot(exercise.long, aes(x=time, y=pulse, group=id))+
  geom_point()+geom_line()+
  facet_grid(diet~exertype)
```

Only for exercise type running is there any time effect worth noting. 

Can I do "simple effects" of diet for the runners? 

Pull out only the runners first:

```{r}
exercise.wide %>%
  filter(exertype=="running") -> runners.wide
```

and then redo all the same analysis on this data frame:

```{r}
response=with(runners.wide, cbind(min01, min15, min30))
runners.1=lm(response~diet, data=runners.wide)
times=colnames(response)
times.df=data.frame(times)
Manova(runners.1, idata=times.df, idesign=~times)
```

Even for the runners, the effect of time is still different for each diet.

Now that we are just focusing on one exercise type, we can do an interaction plot, for which we need long data:

```{r}
runners.wide
runners.wide %>% gather(time, pulse, min01:min30) -> runners.long
runners.long
```

(the other way of doing this is to start with `exercise.long` and filter the runners.)

and then the interaction plot:

```{r}
ggplot(runners.long, aes(x=time, y=pulse, colour=diet, group=diet))+
  stat_summary(fun.y=mean, geom="point") +
  stat_summary(fun.y=mean, geom="line")
```

These are not parallel: the difference in (mean) pulse rates gets larger as time passes. Is this real? Look at spaghetti plot:

```{r}
ggplot(runners.long, aes(x=time, y=pulse, colour=diet, group=id))+
  geom_point()+geom_line()
```

At 1 minute, the pulse rates are all mixed up, at 15 minutes the lowfat ones are mostly higher, and at 30 minutes they are all clearly higher. (What would happen if we took out "time zero", namely 1 minute?)

```{r}
response=with(runners.wide, cbind(min15, min30))
runners.3=lm(response~diet, data=runners.wide)
times=colnames(response) 
times.df=data.frame(times)
Manova(runners.3, idata=times.df, idesign=~times)
```

The interaction is no longer significant. There is a marginally significant time effect (comparing 15 minutes and 30 minutes), and a definite diet effect.



